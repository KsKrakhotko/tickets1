# Диаграмма компонентов системы продажи железнодорожных билетов

## Общая архитектура

Приложение построено по многослойной архитектуре (Layered Architecture) с использованием Spring Boot и следует принципам MVC (Model-View-Controller).

---

## 1. Presentation Layer (Слой представления)

### 1.1. JSP Views (Веб-интерфейс)
**Технология:** JavaServer Pages (JSP) с JSTL

**Основные страницы:**
- `signin.jsp` - страница входа
- `signup.jsp` - страница регистрации
- `home.jsp` - главная страница
- `userHome.jsp` - личный кабинет пользователя
- `adminHome.jsp` - панель администратора
- `booking.jsp` - страница бронирования
- `payment.jsp` - страница оплаты
- `seatSelection.jsp` - выбор места
- `routeSchedule.jsp` - расписание маршрутов
- `adminStations.jsp`, `adminTrains.jsp`, `adminTickets.jsp` - административные страницы
- `reviews.jsp` - отзывы
- `statistic.jsp` - статистика

### 1.2. IndexController
**Тип:** `@Controller` (Spring MVC)

**Ответственность:**
- Обработка GET-запросов для отображения JSP страниц
- Маршрутизация между страницами
- Передача данных в модель для отображения

**Основные методы:**
- `/` → редирект на `/home`
- `/signin`, `/signup` → страницы аутентификации
- `/home`, `/userHome`, `/adminHome` → главные страницы
- `/booking`, `/payment` → страницы бронирования и оплаты
- `/adminStations`, `/adminTrains`, `/adminTickets` → административные страницы

---

## 2. REST API Layer (Слой REST API)

### 2.1. SecurityController
**Тип:** `@RestController`  
**Путь:** `/auth`

**Ответственность:**
- Аутентификация пользователей (signin)
- Регистрация новых пользователей (signup)
- Генерация JWT токенов
- Определение роли пользователя и редирект

**Зависимости:**
- `UserRepository` - работа с пользователями
- `PasswordEncoder` - шифрование паролей
- `AuthenticationManager` - управление аутентификацией
- `JwtCore` - генерация JWT токенов
- `UserService` - бизнес-логика пользователей

### 2.2. TicketController
**Тип:** `@RestController`  
**Путь:** `/tickets`

**Ответственность:**
- CRUD операции с билетами
- Получение билетов пользователя
- Удаление билетов
- Статистика по билетам (количество за сегодня, выручка)

**Зависимости:**
- `TicketService` - бизнес-логика билетов

### 2.3. RouteController
**Тип:** `@RestController`  
**Путь:** `/routes`

**Ответственность:**
- Управление маршрутами
- Создание, обновление, удаление маршрутов
- Поиск маршрутов

**Зависимости:**
- `RouteService` - бизнес-логика маршрутов

### 2.4. TrainController
**Тип:** `@RestController`  
**Путь:** `/trains`

**Ответственность:**
- Управление поездами
- CRUD операции с поездами
- Получение списка всех поездов

**Зависимости:**
- `TrainService` - бизнес-логика поездов

### 2.5. StationController
**Тип:** `@RestController`  
**Путь:** `/stations`

**Ответственность:**
- Управление станциями
- CRUD операции со станциями
- Поиск станций по городу/названию

**Зависимости:**
- `StationService` - бизнес-логика станций

### 2.6. SeatController
**Тип:** `@RestController`  
**Путь:** `/seats`

**Ответственность:**
- Получение информации о доступных местах
- Проверка занятости мест

**Зависимости:**
- `RouteService` - получение информации о маршрутах

### 2.7. PaymentController
**Тип:** `@RestController`  
**Путь:** `/api/payment`

**Ответственность:**
- Обработка платежей
- Валидация данных карты
- Создание билета после оплаты
- Генерация PDF билета
- Отправка билета на email

**Зависимости:**
- `TicketService` - создание билета
- `PdfService` - генерация PDF
- `JavaMailSender` - отправка email

### 2.8. ReviewController
**Тип:** `@RestController`  
**Путь:** `/reviews`

**Ответственность:**
- Управление отзывами
- Создание и получение отзывов

**Зависимости:**
- `ReviewService` - бизнес-логика отзывов

### 2.9. StatisticsController
**Тип:** `@RestController`  
**Путь:** `/statistics`

**Ответственность:**
- Получение статистики продаж
- Выручка за период
- Популярные маршруты

**Зависимости:**
- `TicketService` - статистические данные

### 2.10. ProfileController
**Тип:** `@RestController`  
**Путь:** `/profile`

**Ответственность:**
- Управление профилем пользователя
- Получение данных пользователя

**Зависимости:**
- `UserService` - работа с пользователями

### 2.11. UserAdminController
**Тип:** `@RestController`  
**Путь:** `/admin/users`

**Ответственность:**
- Администрирование пользователей
- CRUD операции с пользователями (для администратора)

**Зависимости:**
- `UserService` - управление пользователями

### 2.12. ContactController
**Тип:** `@RestController`  
**Путь:** `/contact`

**Ответственность:**
- Обработка контактных запросов

### 2.13. MainController
**Тип:** `@RestController`  
**Путь:** `/secured`

**Ответственность:**
- Защищенные ресурсы
- Проверка аутентификации

---

## 3. Business Logic Layer (Слой бизнес-логики)

### 3.1. TicketService
**Тип:** `@Service`

**Основная функциональность:**
- Создание билетов с проверкой доступности мест
- Генерация уникальных PNR кодов
- Управление статусами билетов (active, cancelled)
- Обновление количества доступных мест в маршруте
- Получение статистики:
  - Количество билетов за сегодня
  - Выручка за период
  - Популярные маршруты
  - Количество активных билетов

**Зависимости:**
- `TicketRepository` - доступ к данным билетов
- `RouteRepository` - обновление доступных мест
- `UserRepository` - получение данных пользователя
- `EmailService` - отправка билетов на email

### 3.2. RouteService
**Тип:** `@Service`

**Основная функциональность:**
- Создание и обновление маршрутов
- Поиск маршрутов по параметрам
- Управление расписанием

**Зависимости:**
- `RouteRepository` - доступ к данным маршрутов
- `TrainRepository` - связь с поездами
- `StationRepository` - связь со станциями

### 3.3. TrainService
**Тип:** `@Service`

**Основная функциональность:**
- Создание поездов с проверкой на дубликаты
- Обновление информации о поездах
- Получение списка всех поездов

**Зависимости:**
- `TrainRepository` - доступ к данным поездов

### 3.4. StationService
**Тип:** `@Service`

**Основная функциональность:**
- CRUD операции со станциями
- Поиск станций по городу
- Поиск станций по названию (частичное совпадение)

**Зависимости:**
- `StationRepository` - доступ к данным станций

### 3.5. UserService
**Тип:** `@Service`

**Основная функциональность:**
- Регистрация пользователей
- Получение данных пользователя по ID
- Получение email пользователя

**Зависимости:**
- `UserRepository` - доступ к данным пользователей

### 3.6. ReviewService
**Тип:** `@Service`

**Основная функциональность:**
- Создание отзывов
- Получение списка отзывов

**Зависимости:**
- `ReviewRepository` - доступ к данным отзывов

### 3.7. EmailService
**Тип:** `@Service`

**Основная функциональность:**
- Отправка билетов на email пользователя
- Формирование HTML-письма с информацией о билете
- Прикрепление PDF файла билета

**Зависимости:**
- `JavaMailSender` - отправка email (Spring Mail)
- `PdfService` - генерация PDF билета

### 3.8. PdfService
**Тип:** `@Service`

**Основная функциональность:**
- Генерация PDF документов билетов
- Форматирование информации о билете
- Создание структурированного PDF с данными:
  - PNR код
  - Маршрут (отправление → прибытие)
  - Информация о поезде
  - Дата и время отправления/прибытия
  - Номер места и тип вагона
  - Цена
  - Информация о пассажире

**Технология:** OpenPDF (com.github.librepdf:openpdf)

---

## 4. Security Layer (Слой безопасности)

### 4.1. SecurityConfiguration
**Тип:** `@Configuration`  
**Аннотация:** `@EnableWebSecurity`

**Ответственность:**
- Настройка Spring Security
- Конфигурация SecurityFilterChain
- Настройка правил доступа к ресурсам:
  - `/auth/**` - публичный доступ
  - `/secured/**` - требуется аутентификация
  - Остальные запросы - публичный доступ
- Настройка CORS
- Отключение CSRF (для REST API)
- Настройка stateless сессий (JWT)
- Регистрация TokenFilter

**Зависимости:**
- `TokenFilter` - фильтр для проверки JWT
- `UserService` - для UserDetailsService

### 4.2. TokenFilter
**Тип:** `@Component`  
**Наследует:** `OncePerRequestFilter`

**Ответственность:**
- Извлечение JWT токена из заголовка Authorization
- Парсинг и валидация токена
- Загрузка UserDetails по username из токена
- Установка Authentication в SecurityContext

**Зависимости:**
- `JwtCore` - парсинг JWT токенов
- `UserDetailsService` - загрузка пользователя

### 4.3. JwtCore
**Тип:** `@Component`

**Ответственность:**
- Генерация JWT токенов при аутентификации
- Извлечение данных из токена (username, email, id)
- Парсинг токенов с проверкой подписи

**Технология:** io.jsonwebtoken (jjwt)

**Методы:**
- `generateToken()` - создание токена
- `extractUsername()` - извлечение username
- `extractEmail()` - извлечение email
- `extractId()` - извлечение ID пользователя

### 4.4. UserdetailsImpl
**Тип:** Реализация `UserDetailsService`

**Ответственность:**
- Загрузка пользователя по username для Spring Security
- Преобразование User в UserDetails
- Предоставление информации о правах доступа

**Зависимости:**
- `UserRepository` - получение пользователя из БД

---

## 5. Data Access Layer (Слой доступа к данным)

Все репозитории используют Spring Data JPA и наследуют `JpaRepository`.

### 5.1. TicketRepository
**Сущность:** `Ticket`

**Основные методы:**
- `findByUserId()` - билеты пользователя
- `findByUserAndStatus()` - билеты по статусу
- `findByPnrCode()` - поиск по PNR коду
- `existsByRouteAndSeatNumber()` - проверка занятости места
- `countByPurchaseTimeBetween()` - статистика за период
- `calculateRevenueByPeriod()` - выручка за период
- `countByStatus()` - количество по статусу
- `findSeatNumbersByRouteAndStatus()` - занятые места
- `findPopularRoutesIds()` - популярные маршруты

### 5.2. RouteRepository
**Сущность:** `Route`

**Основные методы:**
- `findByIdWithRelations()` - загрузка со связями
- Стандартные CRUD операции

### 5.3. TrainRepository
**Сущность:** `Train`

**Основные методы:**
- `findByTrainNumber()` - поиск по номеру поезда
- Стандартные CRUD операции

### 5.4. StationRepository
**Сущность:** `Station`

**Основные методы:**
- `findByCity()` - поиск по городу
- `findByNameContainingIgnoreCase()` - поиск по названию
- Стандартные CRUD операции

### 5.5. UserRepository
**Сущность:** `User`

**Основные методы:**
- `findUserByUsername()` - поиск по username
- `existsByUsername()` - проверка существования username
- `existsByEmail()` - проверка существования email
- Стандартные CRUD операции

### 5.6. ReviewRepository
**Сущность:** `Review`

**Основные методы:**
- Стандартные CRUD операции

### 5.7. InfoRepository
**Сущность:** `Info`

**Основные методы:**
- Стандартные CRUD операции

---

## 6. Configuration Layer (Слой конфигурации)

### 6.1. MailConfig
**Тип:** `@Configuration`

**Ответственность:**
- Настройка JavaMailSender для отправки email
- Конфигурация SMTP сервера (Gmail)
- Настройка свойств почты (TLS, аутентификация)

**Параметры из application.properties:**
- `spring.mail.host` - smtp.gmail.com
- `spring.mail.port` - 587
- `spring.mail.username` - email отправителя
- `spring.mail.password` - пароль приложения

---

## 7. External Systems (Внешние системы)

### 7.1. MySQL Database
**База данных:** `railway_tickets_db`

**Основные таблицы:**
- `users` - пользователи системы
- `tickets` - билеты
- `routes` - маршруты
- `trains` - поезда
- `stations` - станции
- `reviews` - отзывы
- `info` - дополнительная информация

**Технология:** MySQL Connector/J  
**ORM:** Hibernate (через Spring Data JPA)

### 7.2. SMTP Server (Gmail)
**Сервер:** smtp.gmail.com:587  
**Протокол:** SMTP с TLS

**Ответственность:**
- Отправка email с билетами пользователям
- HTML форматирование писем
- Прикрепление PDF файлов

---

## Потоки данных

### Поток аутентификации:
1. Клиент → `SecurityController.signin()` → `AuthenticationManager`
2. `AuthenticationManager` → `UserdetailsImpl` → `UserRepository` → MySQL
3. При успехе → `JwtCore.generateToken()` → возврат JWT токена клиенту

### Поток создания билета:
1. Клиент → `PaymentController.processPayment()` → валидация платежа
2. `PaymentController` → `TicketService.createTicket()`
3. `TicketService` → проверка доступности места → `TicketRepository`, `RouteRepository`
4. Создание билета → `TicketRepository.save()` → MySQL
5. Обновление доступных мест → `RouteRepository.save()` → MySQL
6. Генерация PDF → `PdfService.generateTicketPdf()`
7. Отправка email → `EmailService.sendTicketEmail()` → SMTP Server

### Поток запроса защищенного ресурса:
1. Клиент → HTTP запрос с заголовком `Authorization: Bearer <token>`
2. `TokenFilter` → извлечение токена → `JwtCore.extractUsername()`
3. `TokenFilter` → `UserdetailsImpl.loadUserByUsername()` → `UserRepository` → MySQL
4. Установка Authentication в SecurityContext
5. Запрос проходит к контроллеру

---

## Технологический стек

### Backend:
- **Java 17**
- **Spring Boot 3.4.4**
- **Spring MVC** - веб-фреймворк
- **Spring Security** - безопасность
- **Spring Data JPA** - работа с БД
- **Hibernate** - ORM

### Frontend:
- **JSP** - шаблонизация
- **JSTL** - библиотека тегов
- **JavaScript/jQuery** - клиентская логика
- **HTML/CSS** - разметка и стили

### База данных:
- **MySQL** - СУБД
- **MySQL Connector/J** - драйвер

### Безопасность:
- **JWT (jjwt)** - токены аутентификации
- **BCrypt** - хеширование паролей

### Дополнительные библиотеки:
- **OpenPDF** - генерация PDF
- **Spring Mail** - отправка email
- **Lombok** - сокращение boilerplate кода

### Инструменты сборки:
- **Maven** - управление зависимостями и сборка

---

## Принципы проектирования

1. **Separation of Concerns** - разделение ответственности между слоями
2. **Dependency Injection** - использование Spring DI
3. **Repository Pattern** - абстракция доступа к данным
4. **Service Layer Pattern** - бизнес-логика в сервисах
5. **RESTful API** - REST контроллеры для API
6. **MVC Pattern** - разделение на Model, View, Controller


